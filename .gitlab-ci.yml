stages:
  - deploy

variables:
  DOCKER_DRIVER: overlay2

# Deploy to production server
deploy_production:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client docker-cli
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "ðŸš€ Starting deployment to production server..."
      
      # Connect to server and execute deployment
      ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
        set -e
        
        echo "ðŸ“± Connected to server: $(hostname)"
        echo "ðŸ“‚ Current directory: $(pwd)"
        
        # Navigate to project directory
        cd $PROJECT_PATH || {
          echo "âŒ Project directory not found: $PROJECT_PATH"
          exit 1
        }
        
        echo "ðŸ“ Project directory: $PROJECT_PATH"
        
        # Stop running Docker containers
        echo "ðŸ›‘ Stopping Docker containers..."
        if docker-compose -f .deploy/docker-compose.prod.yml down; then
          echo "âœ… Docker containers stopped successfully"
        else
          echo "âŒ Failed to stop Docker containers"
          exit 1
        fi
        
        # Clean up old Docker resources
        echo "ðŸ§¹ Cleaning up Docker resources..."
        docker system prune -f
        docker volume prune -f
        
        # Pull latest changes from Git
        echo "ðŸ“¥ Pulling latest changes from Git..."
        git fetch origin
        git reset --hard origin/main
        
        # Build new Docker image on server
        echo "ðŸ”¨ Building new Docker image on server..."
        if docker build -f .deploy/Dockerfile -t kpt-app:latest .; then
          echo "âœ… Docker image built successfully"
        else
          echo "âŒ Docker build failed"
          exit 1
        fi
        
        # Start Docker containers
        echo "ðŸš€ Starting Docker containers..."
        if docker-compose -f .deploy/docker-compose.prod.yml up -d; then
          echo "âœ… Docker containers started successfully"
        else
          echo "âŒ Failed to start Docker containers"
          exit 1
        fi
        
        # Wait for containers to be healthy
        echo "â³ Waiting for containers to be healthy..."
        sleep 15
        
        # Check container status
        echo "ðŸ” Checking container status..."
        if docker-compose -f .deploy/docker-compose.prod.yml ps | grep -q "Up"; then
          echo "âœ… All containers are running"
        else
          echo "âŒ Some containers are not running"
          docker-compose -f .deploy/docker-compose.prod.yml ps
          exit 1
        fi
        
        # Health check
        echo "ðŸ¥ Performing health check..."
        if curl -f http://localhost:$APP_PORT/health || curl -f http://localhost:$APP_PORT/api/health; then
          echo "âœ… Health check passed"
        else
          echo "âŒ Health check failed"
          exit 1
        fi
        
        # Final cleanup
        echo "ðŸ§¹ Final cleanup..."
        docker system prune -f
        docker image prune -f
        
        echo "ðŸŽ‰ Deployment completed successfully!"
        echo "ðŸ“Š Container status:"
        docker-compose -f .deploy/docker-compose.prod.yml ps
        echo "ðŸ’¾ Disk usage:"
        df -h
        echo "ðŸ³ Docker disk usage:"
        docker system df
      EOF
      
      if [ $? -eq 0 ]; then
        echo "âœ… Production deployment completed successfully!"
      else
        echo "âŒ Production deployment failed!"
        exit 1
      fi
      
  environment:
    name: production
    url: http://$SSH_HOST:$APP_PORT
  only:
    - main
  when: manual
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Deploy to staging server
deploy_staging:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client docker-cli
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "ðŸš€ Starting deployment to staging server..."
      
      # Connect to server and execute deployment
      ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
        set -e
        
        echo "ðŸ“± Connected to staging server: $(hostname)"
        echo "ðŸ“‚ Current directory: $(pwd)"
        
        # Navigate to staging project directory
        cd $STAGING_PROJECT_PATH || {
          echo "âŒ Staging project directory not found: $STAGING_PROJECT_PATH"
          exit 1
        }
        
        echo "ðŸ“ Staging project directory: $STAGING_PROJECT_PATH"
        
        # Stop running Docker containers
        echo "ðŸ›‘ Stopping staging Docker containers..."
        if docker-compose -f .deploy/docker-compose.stg.yml down; then
          echo "âœ… Staging Docker containers stopped successfully"
        else
          echo "âŒ Failed to stop staging Docker containers"
          exit 1
        fi
        
        # Clean up old Docker resources
        echo "ðŸ§¹ Cleaning up staging Docker resources..."
        docker system prune -f
        docker volume prune -f
        
        # Pull latest changes from Git
        echo "ðŸ“¥ Pulling latest changes from Git..."
        git fetch origin
        git reset --hard origin/develop
        
        # Build new Docker image on server
        echo "ðŸ”¨ Building new staging Docker image on server..."
        if docker build -f .deploy/Dockerfile.stg -t kpt-app:staging .; then
          echo "âœ… Staging Docker image built successfully"
        else
          echo "âŒ Staging Docker build failed"
          exit 1
        fi
        
        # Start Docker containers
        echo "ðŸš€ Starting staging Docker containers..."
        if docker-compose -f .deploy/docker-compose.stg.yml up -d; then
          echo "âœ… Staging Docker containers started successfully"
        else
          echo "âŒ Failed to start staging Docker containers"
          exit 1
        fi
        
        # Wait for containers to be healthy
        echo "â³ Waiting for staging containers to be healthy..."
        sleep 15
        
        # Check container status
        echo "ðŸ” Checking staging container status..."
        if docker-compose -f .deploy/docker-compose.stg.yml ps | grep -q "Up"; then
          echo "âœ… All staging containers are running"
        else
          echo "âŒ Some staging containers are not running"
          docker-compose -f .deploy/docker-compose.stg.yml ps
          exit 1
        fi
        
        # Health check
        echo "ðŸ¥ Performing staging health check..."
        if curl -f http://localhost:$STAGING_APP_PORT/health || curl -f http://localhost:$STAGING_APP_PORT/api/health; then
          echo "âœ… Staging health check passed"
        else
          echo "âŒ Staging health check failed"
          exit 1
        fi
        
        # Final cleanup
        echo "ðŸ§¹ Final staging cleanup..."
        docker system prune -f
        docker image prune -f
        
        echo "ðŸŽ‰ Staging deployment completed successfully!"
        echo "ðŸ“Š Staging container status:"
        docker-compose -f .deploy/docker-compose.stg.yml ps
      EOF
      
      if [ $? -eq 0 ]; then
        echo "âœ… Staging deployment completed successfully!"
      else
        echo "âŒ Staging deployment failed!"
        exit 1
      fi
      
  environment:
    name: staging
    url: http://$SSH_HOST:$STAGING_APP_PORT
  only:
    - develop
  when: manual
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# Emergency rollback
rollback:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client docker-cli
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KNOWN_HOSTS" >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - |
      echo "ðŸ”„ Starting emergency rollback..."
      
      # Connect to server and execute rollback
      ssh -o StrictHostKeyChecking=no $SSH_USER@$SSH_HOST << 'EOF'
        set -e
        
        echo "ðŸ“± Connected to server: $(hostname)"
        
        # Navigate to project directory
        cd $PROJECT_PATH || {
          echo "âŒ Project directory not found: $PROJECT_PATH"
          exit 1
        }
        
        echo "ðŸ“ Project directory: $PROJECT_PATH"
        
        # Stop current containers
        echo "ðŸ›‘ Stopping current containers..."
        docker-compose -f .deploy/docker-compose.prod.yml down
        
        # Check if we have a previous image
        if docker images | grep -q "kpt-app:previous"; then
          echo "ðŸ”„ Rolling back to previous version..."
          
          # Tag current as backup
          docker tag kpt-app:latest kpt-app:failed || true
          
          # Restore previous version
          docker tag kpt-app:previous kpt-app:latest
          
          # Start containers with previous version
          echo "ðŸš€ Starting containers with previous version..."
          if docker-compose -f .deploy/docker-compose.prod.yml up -d; then
            echo "âœ… Rollback completed successfully!"
          else
            echo "âŒ Rollback failed!"
            exit 1
          fi
        else
          echo "âŒ No previous version available for rollback"
          exit 1
        fi
        
        # Health check after rollback
        echo "ðŸ¥ Performing health check after rollback..."
        sleep 15
        if curl -f http://localhost:$APP_PORT/health || curl -f http://localhost:$APP_PORT/api/health; then
          echo "âœ… Rollback health check passed"
        else
          echo "âŒ Rollback health check failed"
          exit 1
        fi
        
        echo "ðŸŽ‰ Emergency rollback completed successfully!"
      EOF
      
      if [ $? -eq 0 ]; then
        echo "âœ… Emergency rollback completed successfully!"
      else
        echo "âŒ Emergency rollback failed!"
        exit 1
      fi
      
  environment:
    name: production
    url: http://$SSH_HOST:$APP_PORT
  only:
    - main
  when: manual
  retry:
    max: 1
    when:
      - runner_system_failure
