# GitLab CI/CD Setup

## ๐ ะงัะพ ะดะตะปะฐะตั ััะพั pipeline:

1. **ะะพะดะบะปััะฐะตััั ะบ ัะตัะฒะตัั ะฟะพ SSH**
2. **ะััะฐะฝะฐะฒะปะธะฒะฐะตั Docker ะบะพะฝัะตะนะฝะตัั**
3. **ะกะพะฑะธัะฐะตั Docker ะพะฑัะฐะท ะฝะฐ ัะตัะฒะตัะต**
4. **ะะฐะฟััะบะฐะตั ะฝะพะฒัะต ะบะพะฝัะตะนะฝะตัั**
5. **ะัะธัะฐะตั ะปะธัะฝะธะต Docker ัะตััััั**
6. **ะัะพะฒะตััะตั ะทะดะพัะพะฒัะต ะฟัะธะปะพะถะตะฝะธั**

## โ๏ธ ะะฐัััะพะนะบะฐ GitLab Variables

ะะพะฑะฐะฒััะต ะฒ GitLab โ Settings โ CI/CD โ Variables:

| ะะตัะตะผะตะฝะฝะฐั | ะะฟะธัะฐะฝะธะต | ะัะธะผะตั |
|------------|----------|---------|
| `SSH_PRIVATE_KEY` | ะัะธะฒะฐัะฝัะน SSH ะบะปัั | ะกะพะดะตัะถะธะผะพะต ัะฐะนะปะฐ `~/.ssh/id_rsa` |
| `SSH_KNOWN_HOSTS` | SSH fingerprint ัะตัะฒะตัะฐ | ะัะฒะพะด ะบะพะผะฐะฝะดั `ssh-keyscan your-server-ip` |
| `SSH_USER` | ะะพะปัะทะพะฒะฐัะตะปั ะดะปั SSH | `ubuntu` ะธะปะธ `root` |
| `SSH_HOST` | IP ะธะปะธ ะดะพะผะตะฝ ัะตัะฒะตัะฐ | `192.168.1.100` |
| `PROJECT_PATH` | ะััั ะบ ะฟัะพะตะบัั ะฝะฐ ัะตัะฒะตัะต | `/opt/kpt-app` |
| `STAGING_PROJECT_PATH` | ะััั ะบ staging ะฟัะพะตะบัั | `/opt/kpt-app-staging` |
| `APP_PORT` | ะะพัั production ะฟัะธะปะพะถะตะฝะธั | `3000` |
| `STAGING_APP_PORT` | ะะพัั staging ะฟัะธะปะพะถะตะฝะธั | `3001` |

## ๐ ะะฐัััะพะนะบะฐ SSH ะฝะฐ ัะตัะฒะตัะต:

```bash
# ะกะพะทะดะฐัั SSH ะบะปัั
ssh-keygen -t rsa -b 4096 -f ~/.ssh/gitlab_ci

# ะะพะฑะฐะฒะธัั ะฒ authorized_keys
cat ~/.ssh/gitlab_ci.pub >> ~/.ssh/authorized_keys

# ะฃััะฐะฝะพะฒะธัั ะฟัะฐะฒะฐ
chmod 600 ~/.ssh/gitlab_ci
chmod 644 ~/.ssh/authorized_keys

# ะะพะปััะธัั fingerprint ัะตัะฒะตัะฐ
ssh-keyscan your-server-ip
```

## ๐ ะกัััะบัััะฐ ะฝะฐ ัะตัะฒะตัะต:

```
/opt/kpt-app/
โโโ .deploy/
โ   โโโ docker-compose.prod.yml
โ   โโโ docker-compose.stg.yml
โ   โโโ Dockerfile
โ   โโโ Dockerfile.stg
โโโ src/
โโโ package.json
```

## ๐ ะัะฟะพะปัะทะพะฒะฐะฝะธะต:

- **Push ะฒ `main`** โ ะะฐะฟััะบะฐะตั `deploy_production`
- **Push ะฒ `develop`** โ ะะฐะฟััะบะฐะตั `deploy_staging`
- **ะััะฝะพะน ะทะฐะฟััะบ** โ ะงะตัะตะท GitLab CI/CD โ Pipelines

## ๐ Rollback:

ะัะปะธ ััะพ-ัะพ ะฟะพัะปะพ ะฝะต ัะฐะบ, ะธัะฟะพะปัะทัะนัะต job `rollback` ะดะปั ะพัะบะฐัะฐ ะบ ะฟัะตะดัะดััะตะน ะฒะตััะธะธ.

## โ ะัะพะฒะตัะบะฐ:

ะะพัะปะต ะดะตะฟะปะพั ะฟัะพะฒะตัััะต:
- ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ: `docker-compose ps`
- ะะพะณะธ: `docker-compose logs -f`
- Health check: `curl http://localhost:3000/health`
