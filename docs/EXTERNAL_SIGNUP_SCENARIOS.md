# External signup — сценарии для фронтенда и тестировщика

Описание поведения API и ожидаемых результатов по каждому сценарию. Эндпоинты: **POST /public/external/start-signup**, **GET /public/external/signup-result?app_user_id=...** (см. [EXTERNAL_SIGNUP_API_FOR_FRONTEND.md](./EXTERNAL_SIGNUP_API_FOR_FRONTEND.md)).

---

## 1. Новый пользователь — успешная оплата

**Исходные данные:**  
Email в системе не зарегистрирован (нет в `users`).

**Действия:**  
1. Вызвать **POST /public/external/start-signup** (email, quiz, programId, programName).  
2. Получить `app_user_id`, открыть чекаут Paddle с этим `app_user_id`.  
3. Успешно оплатить.  
4. Вызвать **GET /public/external/signup-result?app_user_id=...**.

**Ожидаемый результат:**  
- **start-signup:** 200, в ответе `{ "appUserId": "web_signup_..." }`.  
- **signup-result (после оплаты):** 200, `{ "registrationLink": "...", "accessToken": "...", "refreshToken": "..." }`.  
- На email уходит письмо с временным паролем.  
- В приложении пользователь залогинен по токенам; в БД создан новый пользователь с выбранной программой и quizSnapshot.

---

## 2. Новый пользователь — неуспешная оплата

**Исходные данные:**  
Email в системе не зарегистрирован.

**Действия:**  
1. Вызвать **POST /public/external/start-signup**.  
2. Открыть чекаут, **не завершать** оплату (закрыть окно, отменить, ошибка карты и т.п.).

**Ожидаемый результат:**  
- **start-signup:** 200, `app_user_id` выдан.  
- Пользователь в БД **не создаётся**.  
- **GET /public/external/signup-result?app_user_id=...** возвращает **404** (оплата не обработана).

---

## 3. Новый пользователь — повторная попытка после неуспешной оплаты

**Исходные данные:**  
Тот же email, что в сценарии 2; оплата не была завершена.

**Действия:**  
1. Снова вызвать **POST /public/external/start-signup** с тем же email, теми же или другими quiz/programId.  
2. Получить тот же `app_user_id` (запись в `external_signups` обновлена, не создаётся дубликат).  
3. Открыть чекаут и на этот раз **успешно оплатить**.  
4. Вызвать **GET /public/external/signup-result?app_user_id=...**.

**Ожидаемый результат:**  
- **start-signup:** 200, в ответе **тот же** `appUserId`, что и при первой попытке.  
- После успешной оплаты **signup-result:** 200, токены и ссылка.  
- Создаётся один пользователь; данные (программа, квиз) взяты из последнего вызова start-signup.

---

## 4. Существующий пользователь с активной подпиской

**Исходные данные:**  
Email уже есть в `users`, у пользователя **есть активная подписка** (`hasPaidSubscription = true`).

**Действия:**  
1. Вызвать **POST /public/external/start-signup** с этим email.

**Ожидаемый результат:**  
- **start-signup:** **409 Conflict**, сообщение в духе: «This email is already registered with an active subscription. Please log in to the app.»  
- Чекаут не открывать; пользователю показать: «Войдите в приложение» / редирект на логин.

---

## 5. Существующий пользователь без активной подписки (подписка истекла) — успешная оплата

**Исходные данные:**  
Email есть в `users`, у пользователя **нет активной подписки** (подписка закончилась или никогда не было).

**Действия:**  
1. Вызвать **POST /public/external/start-signup** с этим email (quiz, programId, programName).  
2. Получить `app_user_id`, открыть чекаут, **успешно оплатить**.  
3. Вызвать **GET /public/external/signup-result?app_user_id=...**.

**Ожидаемый результат:**  
- **start-signup:** 200, `{ "appUserId": "web_signup_..." }`.  
- После оплаты **signup-result:** 200, токены и `registrationLink`.  
- **Новый пользователь не создаётся.** Обновляется существующий: привязывается новая подписка, при необходимости обновляются `selectedProgram` и `quizSnapshot` из последнего start-signup.  
- Письмо с временным паролем **не отправляется** (у пользователя уже есть аккаунт).  
- Пользователь входит в приложение по выданным токенам в свой существующий аккаунт.

---

## 6. Существующий пользователь без активной подписки — неуспешная оплата

**Исходные данные:**  
Email есть в `users`, активной подписки нет.

**Действия:**  
1. Вызвать **POST /public/external/start-signup** с этим email.  
2. Открыть чекаут и **не завершить** оплату.

**Ожидаемый результат:**  
- **start-signup:** 200, `app_user_id` выдан.  
- **signup-result** по этому `app_user_id` возвращает **404** (оплата не прошла).  
- Пользователь в БД остаётся без новой подписки; данные пользователя не меняются.

---

## 7. Существующий пользователь без активной подписки — повторная попытка после неуспешной оплаты

**Исходные данные:**  
Тот же пользователь (email в `users`, без активной подписки); первая попытка оплаты не была завершена.

**Действия:**  
1. Снова вызвать **POST /public/external/start-signup** с тем же email (можно изменить quiz/program).  
2. Получить тот же `app_user_id` (запись обновлена).  
3. Открыть чекаут и **успешно оплатить**.  
4. Вызвать **GET /public/external/signup-result?app_user_id=...**.

**Ожидаемый результат:**  
- **start-signup:** 200, **тот же** `appUserId`.  
- После успешной оплаты **signup-result:** 200, токены.  
- Подписка привязывается к существующему пользователю; при необходимости обновляются программа и quiz из последнего start-signup. Письмо с паролем не отправляется.

---

## Краткая сводка ответов start-signup

| Ситуация | start-signup ответ | Дальнейшие действия |
|----------|--------------------|----------------------|
| Email новый | 200, `appUserId` | Чекаут → оплата → signup-result |
| Email новый, уже есть pending | 200, тот же `appUserId` | Чекаут → оплата → signup-result |
| Email есть в БД, активная подписка | 409 | Показать «Войдите в приложение» |
| Email есть в БД, подписки нет / истекла | 200, `appUserId` | Чекаут → оплата → signup-result (вход в существующий аккаунт) |
| Email есть в БД без подписки, уже есть pending | 200, тот же `appUserId` | Чекаут → оплата → signup-result |

---

## signup-result

- **200** — оплата обработана, в ответе `registrationLink`, `accessToken`, `refreshToken`. Передать токены в приложение для входа.  
- **404** — запись не найдена или оплата ещё не обработана (повторить через 2–3 сек при задержке вебхука).
