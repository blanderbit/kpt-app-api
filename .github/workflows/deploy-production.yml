name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate required secrets
      run: |
        echo "ðŸ” Checking required secrets..."
        
        if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
          echo "âŒ SSH_PRIVATE_KEY secret is not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SSH_USER }}" ]; then
          echo "âŒ SSH_USER secret is not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.SSH_HOST }}" ]; then
          echo "âŒ SSH_HOST secret is not set"
          exit 1
        fi
        
        if [ -z "${{ secrets.PROJECT_PATH }}" ]; then
          echo "âŒ PROJECT_PATH secret is not set"
          exit 1
        fi
        
        echo "âœ… All required secrets are present"
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -t rsa,ecdsa,ed25519 ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts
        
    - name: Deploy to production server
      run: |
        echo "ðŸš€ Starting deployment to production server..."
        
        ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} << 'EOF'
          set -e
          
          echo "ðŸ“± Connected to server: $(hostname)"
          echo "ðŸ“‚ Current directory: $(pwd)"
          
          # Navigate to project directory
          cd ${{ secrets.PROJECT_PATH }} || {
            echo "âŒ Project directory not found: ${{ secrets.PROJECT_PATH }}"
            exit 1
          }
          
          echo "ðŸ“ Project directory: ${{ secrets.PROJECT_PATH }}"
          
          # Backup current image before deployment
          echo "ðŸ’¾ Backing up current production image..."
          if docker images | grep -q "kpt-app:latest"; then
            docker tag kpt-app:latest kpt-app:previous || true
            echo "âœ… Current image backed up as kpt-app:previous"
          fi
          
          # Stop running Docker containers
          echo "ðŸ›‘ Stopping Docker containers..."
          if docker-compose -f .deploy/docker-compose.prod.yml down; then
            echo "âœ… Docker containers stopped successfully"
          else
            echo "âŒ Failed to stop Docker containers"
            exit 1
          fi
          
          # Clean up old Docker resources
          echo "ðŸ§¹ Cleaning up Docker resources..."
          docker system prune -f
          docker volume prune -f
          
          # Pull latest changes from Git
          echo "ðŸ“¥ Pulling latest changes from Git..."
          git pull origin
          
          # Build new Docker image on server
          echo "ðŸ”¨ Building new Docker image on server..."
          if docker build -f .deploy/Dockerfile -t kpt-app:latest .; then
            echo "âœ… Docker image built successfully"
          else
            echo "âŒ Docker build failed"
            exit 1
          fi
          
          # Start Docker containers
          echo "ðŸš€ Starting Docker containers..."
          if docker-compose -f .deploy/docker-compose.prod.yml up -d; then
            echo "âœ… Docker containers started successfully"
          else
            echo "âŒ Failed to start Docker containers"
            exit 1
          fi
          
          # Wait for containers to be healthy
          echo "â³ Waiting for containers to be healthy..."
          sleep 15
          
          # Check container status
          echo "ðŸ” Checking container status..."
          if docker-compose -f .deploy/docker-compose.prod.yml ps | grep -q "Up"; then
            echo "âœ… All containers are running"
          else
            echo "âŒ Some containers are not running"
            docker-compose -f .deploy/docker-compose.prod.yml ps
            exit 1
          fi
          
          # Health check
          echo "ðŸ¥ Performing health check..."
          if curl -f http://localhost:${{ secrets.APP_PORT }}/health || curl -f http://localhost:${{ secrets.APP_PORT }}/api/health; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            exit 1
          fi
          
          # Final cleanup
          echo "ðŸ§¹ Final cleanup..."
          docker system prune -f
          docker image prune -f
          
          echo "ðŸŽ‰ Deployment completed successfully!"
          echo "ðŸ“Š Container status:"
          docker-compose -f .deploy/docker-compose.prod.yml ps
          echo "ðŸ’¾ Disk usage:"
          df -h
          echo "ðŸ³ Docker disk usage:"
          docker system df
        EOF
        
        if [ $? -eq 0 ]; then
          echo "âœ… Production deployment completed successfully!"
        else
          echo "âŒ Production deployment failed!"
          exit 1
        fi
